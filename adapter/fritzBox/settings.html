<table style="font-size: 12px" id="fritzBox_table">
    <tr>
        <td class="translate">Enabled:</td>
        <td colspan="4">
            <select id="fritzbox_enabled">
                <option value="false" class="translate">false</option>
                <option value="true"  class="translate">true</option>
            </select>
        </td>
    </tr>
    <tr>
        <td class="translate">IP address:</td>
        <td style="width: 100px"><input id="fritzbox_settings_ip" style="width:100px" type="text"></td>
        <td colspan="3" class="translate">IP address of the fritz.box!</td>
    </tr>
    <tr>
        <td class="translate">Max stored calls:</td>
        <td style="width: 100px"><input id="fritzbox_settings_maxAll" style="width:50px" type="text"></td>
        <td colspan="3" class="translate">Number of the stored all type calls.</td>
    </tr>
    <tr>
        <td class="translate">Max stored missed calls:</td>
        <td style="width: 100px"><input id="fritzbox_settings_maxMissed" style="width:50px" type="text"></td>
        <td colspan="3" class="translate">Number of the stored missed calls.</td>
    </tr>
    <tr>
        <td colspan="5" style="height:20px"></td>
    </tr>
    <tr>
        <td colspan="5"><h3 class="translate">Phonebook</h3></td>
    </tr>

    <tr>
        <th style="width:32px"></th>
        <th class="translate">Number</th>
        <th class="translate">Name</th>
        <th class="translate">Image</th>
        <th></th>
    </tr>
</table>
<input type="button" class="translateV" id="add_name" value="add name"/><br><br>

<p>
<h1 class="translate">Description</h1>
<span class="translate">Description text</span>
</p>
<script src="../lib/js/selectImage.js" type="text/javascript"></script>
<script type="text/javascript">
    var adapterWords = {
        "false":             {"en": "false",             "de": "nein",            "ru": "нет"},
        "true":              {"en": "true",              "de": "ja",              "ru": "да"},
        "Enabled:":          {"en": "Enabled:",          "de": "Aktiviert:",      "ru": "Активно:"},
        "IP address:":       {"en": "IP address:",       "de": "IP-Adresse:",     "ru": "IP адрес"},
        "add name":          {"en": "add name",          "de": "Name einfügen",   "ru": "Добавить"},
        "remove":            {"en": "remove",            "de": "Löschen",         "ru": "удалить"},
        "Max stored calls:": {"en": "Max stored calls:", "de": "Anrufenanazahl:", "ru": "Число звонков:"},
        "Number of the stored all type calls.": {
            "en": "Number of the stored all type calls.",
            "de": "Anzahl von maximal gespeicherten Anrufen.",
            "ru": "Максимальное количество сохранённых звонков."},
        "IP address of the fritz.box!": {
            "en": "IP address of the fritz.box!",
            "de": "IP-Adresse von fritz.box!",
            "ru": "IP адрес fritz.box!"},
        "Max stored missed calls:": {"en": "Max stored missed calls:", "de": "Max. verpasste Anrufe:", "ru": "Пропущенные звонки:"},
        "Number of the stored missed calls.": {
            "en": "Number of the stored missed calls.",
            "de": "Anzahl von maximal gespeicherten verpassten Anrufen.",
            "ru": "Максимальное количество сохранённых пропущенных звонков."},
        "Phonebook":         {"en": "Phone book",  "de": "Telefonbuch",  "ru": "Телефонная книга"},
        "Number":            {"en": "Number",      "de": "Nummer",       "ru": "Номер"},
        "Name":              {"en": "Name",        "de": "Name",         "ru": "Имя"},
        "Image":             {"en": "Image",       "de": "Bildpfad",     "ru": "Путь к картинке"},
        "Description":       {"en": "Description", "de": "Beschreibung", "ru": "Описание"},
        "Description text":  {
            "en": "The fritz!box has an integrated call monitor that can be activated by dialling #96*5* (and deactivated by #96*4*).<br>"
            + "Additionally the CCU.IO adapter has to be enabled too.<br>"
            + "Following objects will be created:<br>"
            + "1. 73200 - STATE [NONE | RING | TALKING ]<br>"
            + "2. 73201 - RINGING: true if STATE is RING<br>"
            + "3. 73202 - MISSED: count of missed calls. Can be cleared with value 0.<br>"
            + "4. 73203 - MISSED_LIST: list of missed calls in form \"MISSED/14.01.14 23:01:03/Caller Number/0\".<br>"
            + "5. 73204 - MISSED_LIST_FMT: formatted list of last missed calls for HTML.<br>"
            + "6. 73205 - LAST_MISSED: Name or number of last missed call.<br>"
            + "7. 73206 - RINGING_NUMBER: Name or number of actual ringing call. Will be set to \"\" after ring is over.<br>"
            + "8. 73207 - RINGING_IMAGE: Picture of actual ringing call. Will be set to \"\" after ring is over.<br>"
            + "9. 73208 - ALL_LIST: list of all calls in form \"type/14.01.14 23:01:03/Caller Number/Duration\".<br>"
            + "10.73209 - ALL_LIST_FMT: formatted list of all calls for HTML.<br>",

            "de": "fritz!box hat integrierten Anrufmonior. Der kann dürch Anruf #96*5* aktiviert werden (und deaktiviert mit #96*4*).<br>"
            + "Additionally the CCU.IO adapter has to be enabled too.<br>"
            + "Folgende Objekte für die Interkommunikation mit dem Anrufmonitor werden zur Verfügung gestellt:<br>"
            + "1. 73200 - STATE [NONE | RING | TALKING ]<br>"
            + "2. 73201 - RINGING: \"true\" falls STATE ist RING<br>"
            + "3. 73202 - MISSED: Anzahl von vermissten Anrufen. Kann mit schreiben von 0 gelöscht werden.<br>"
            + "4. 73203 - MISSED_LIST: Die Liste von vermissten Anrufen in eine Form von \"MISSED/14.01.14 23:01:03/Caller Number/0\".<br>"
            + "5. 73204 - MISSED_LIST_FMT: Die formatierte Liste von vermissten Anrufen für HTML.<br>"
            + "6. 73205 - LAST_MISSED: Name oder Nummer vom letzten vermiessten Anruf.<br>"
            + "7. 73206 - RINGING_NUMBER: Name oder Nummer vom aktuellen Anruf. Nach dem als Anruf zu ende ist, wird wieder gelöscht.<br>"
            + "8. 73207 - RINGING_IMAGE: Der Bildchen-Pfad vom aktuellen Anruf. Nach dem als Anruf zu ende ist, wird wieder gelöscht.<br>"
            + "9. 73208 - ALL_LIST: Die Liste von allen Anrufen in eine Form von \"type/14.01.14 23:01:03/Caller Number/Duration\".<br>"
            + "10.73209 - ALL_LIST_FMT: Die formatierte Liste von allen Anrufen für HTML.<br>",

            "ru": "fritz!box обладает встроенным монитором звонков, который можно активировать набором на телефоне номера #96*5* (и деактивировать с #96*4*).<br>"
            + "Конечно, сам fritz.Box! драйвер дожен быть тоже активирован.<br>"
            + "Драйвер предоставляет следующие объекты для взаимодействия с монитором:<br>"
            + "1. 73200 - STATE [NONE | RING | TALKING ]<br>"
            + "2. 73201 - RINGING: true если STATE = RING<br>"
            + "3. 73202 - MISSED: число пропущенных звонков. Может быть обнулен, если записать в него 0.<br>"
            + "4. 73203 - MISSED_LIST: список пропущенных звонков в виде \"MISSED/14.01.14 23:01:03/Caller Number/0\".<br>"
            + "5. 73204 - MISSED_LIST_FMT: форматированный список пропущенных звонков для HTML.<br>"
            + "6. 73205 - LAST_MISSED: Имя или номер последнего пропущенного звонка.<br>"
            + "7. 73206 - RINGING_NUMBER: Имя или номер звонящего в настоящий момент. Будет затерто, как только звонок прекратится.<br>"
            + "8. 73207 - RINGING_IMAGE: Путь к картике звонящего в настоящий момент. Будет затерто, как только звонок прекратится.<br>"
            + "9. 73208 - ALL_LIST: список всех звонков в виде \"type/14.01.14 23:01:03/Caller Number/Duration\".<br>"
            + "10.73209 - ALL_LIST_FMT: форматированный список всех звонков для HTML.<br>"
        }
    };
</script>

<script type="text/javascript">
    var socket = io.connect( $(location).attr('protocol') + '//' +  $(location).attr('host') + "?key="+socketSession);
    imageSelect._rootDir = "www/ccu.io/img/";

    function storeSettings () {
        updateAdapterSettings();
    }

    if (currentAdapterSettings.enabled) {
        $("#fritzbox_enabled option[value='false']").removeAttr("selected");
        $("#fritzbox_enabled option[value='true']").attr("selected", true);
    } else {
        $("#fritzbox_enabled option[value='true']").removeAttr("selected");
        $("#fritzbox_enabled option[value='false']").attr("selected", true);
    }

    $("#fritzbox_enabled").change(function () {
        currentAdapterSettings.enabled = ($("#fritzbox_enabled option:selected").val() == "false" ? false : true);
        storeSettings();
    });

    $("#fritzbox_settings_ip").val(currentAdapterSettings.settings.IP || "192.168.1.1");

    $("#fritzbox_settings_ip").change(function () {
        currentAdapterSettings.settings.IP = $(this).val();
        storeSettings();
    });

    $("#fritzbox_settings_maxMissed").val(currentAdapterSettings.settings.maxMissed === undefined ? 10 : currentAdapterSettings.settings.maxMissed);

    $("#fritzbox_settings_maxMissed").change(function () {
        currentAdapterSettings.settings.maxMissed = $(this).val();
        if (currentAdapterSettings.settings.maxMissed > 100) {
            currentAdapterSettings.settings.maxMissed = 100;
            $(this).val(currentAdapterSettings.settings.maxMissed);
        }
        storeSettings();
    });

    $("#fritzbox_settings_maxAll").val(currentAdapterSettings.settings.maxAll === undefined ? 20 : currentAdapterSettings.settings.maxMissed);

    $("#fritzbox_settings_maxAll").change(function () {
        currentAdapterSettings.settings.maxAll = $(this).val();
        if (currentAdapterSettings.settings.maxAll > 100) {
            currentAdapterSettings.settings.maxAll = 100;
            $(this).val(currentAdapterSettings.settings.maxAll);
        }
        storeSettings();
    });

    function showEntry (id) {
        console.log(currentAdapterSettings.settings.phonebook[id]);

        var sText = '<tr class="fritzBox-optentry">';
        sText += '<td><img id="fritzBox_image_'    +id+'" data-fritzBox-entry="'+id+'" src="'+(currentAdapterSettings.settings.phonebook[id].img || "/ccu.io/img/call.png")+'" width="32" height="32"/></td>';
        sText += '<td><input id="fritzBox_number_' +id+'" data-fritzBox-entry="'+id+'" type="text" value="'+(currentAdapterSettings.settings.phonebook[id].number || "")+'"/></td>';
        sText += '<td><input id="fritzBox_name_'   +id+'" data-fritzBox-entry="'+id+'" type="text" value="'+(currentAdapterSettings.settings.phonebook[id].name   || "")+'"/></td>';
        sText += '<td><input id="fritzBox_img_'    +id+'" data-fritzBox-entry="'+id+'" type="text" value="'+(currentAdapterSettings.settings.phonebook[id].img    || "")+'"/><input type="button" id="fritzBox_img_btn_'+id+'" data-fritzBox-entry="'+id+'" value="..."></td>';
        sText += '<td><input data-fritzBox-entry="'+id+'" type="button" value="'+translateWord('remove', ((ccuIoSettings && ccuIoSettings.language) ? ccuIoSettings.language : 'en'), adapterWords)+'" class="fritzBox-remove translateV" data-lang="'+((ccuIoSettings && ccuIoSettings.language) ? ccuIoSettings.language : 'en')+'"/></td>';
        sText += "</tr>";

        $("#fritzBox_table").append(sText);

        $(".fritzBox-remove:last").button().click(function () {
            fritzBoxRemoveEntry($(this).attr("data-fritzBox-entry"));
            storeSettings();
        }).keyup(function() { $(this).trigger("change")});

        $("#fritzBox_number_"+id).change(function () {
            currentAdapterSettings.settings.phonebook[$(this).attr('data-fritzBox-entry')].number = $(this).val();
            storeSettings();
        }).keyup(function() { $(this).trigger("change")});

        $("#fritzBox_name_"+id).change(function () {
            currentAdapterSettings.settings.phonebook[$(this).attr('data-fritzBox-entry')].name = $(this).val();
            storeSettings();
        }).keyup(function() { $(this).trigger("change")});

        $("#fritzBox_img_"+id).change(function () {
            currentAdapterSettings.settings.phonebook[$(this).attr('data-fritzBox-entry')].img = $(this).val();
            $('#fritzBox_image_' + $(this).attr('data-fritzBox-entry')).attr("src", $(this).val() || "/ccu.io/img/call.png");
            storeSettings();
        }).keyup(function() { $(this).trigger("change")});

        // Select image Dialog
        $("#fritzBox_img_btn_"+id).click ( function () {
            var img = $("#fritzBox_img_"+$(this).attr('data-fritzBox-entry')).val();
            img = img.replace ("/ccu.io/", "");
            var settings = {
                current: img,
                onselectArg: $(this).attr('data-fritzBox-entry'),
                onselect:    function (img, obj)
                {
                    $("#fritzBox_img_"+obj).val("/ccu.io/" + img);
                    $("#fritzBox_img_"+obj).trigger("change");
                }};
            imageSelect.Show (settings, socket);
        });
    }

    $("#add_name").button().click(function () {
        currentAdapterSettings.settings.phonebook[currentAdapterSettings.settings.phonebook.length] = {number: "", name:"", img: ""};
        showEntry (currentAdapterSettings.settings.phonebook.length - 1);
    });

    function fritzBoxRemoveEntry(j) {
        $("tr.fritzBox-optentry").remove();
        currentAdapterSettings.settings.phonebook.splice(j, 1);
        fritzBoxRefreshNames();
        storeSettings();
    }
    function fritzBoxRefreshNames () {
        for (var i = 0; i < currentAdapterSettings.settings.phonebook.length; i++) {
            showEntry (i);
        }
    }

    fritzBoxRefreshNames();
    translateAll (ccuIoSettings.language, adapterWords);

</script>

<table style="font-size: 12px" id="fritzBox_table">
    <tr>
        <td class="translate">Enabled:</td>
        <td colspan="4">
            <select id="fritzbox_enabled">
                <option value="false" class="translate">false</option>
                <option value="true"  class="translate">true</option>
            </select>
        </td>
    </tr>
    <tr>
        <td class="translate">IP address:</td>
        <td style="width: 100px"><input id="fritzbox_settings_ip" style="width:100px" type="text"></td>
        <td colspan="3" class="translate">IP address of the fritz.box!</td>
    </tr>
    <tr>
        <td class="translate">Max stored calls:</td>
        <td style="width: 100px"><input id="fritzbox_settings_maxAll" style="width:50px" type="text"></td>
        <td colspan="3" class="translate">Number of the stored all type calls.</td>
    </tr>
    <tr>
        <td class="translate">Max stored missed calls:</td>
        <td style="width: 100px"><input id="fritzbox_settings_maxMissed" style="width:50px" type="text"></td>
        <td colspan="3" class="translate">Number of the stored missed calls.</td>
    </tr>
    <tr>
        <td colspan="5" style="height:20px"></td>
    </tr>
    <tr>
        <td colspan="5"><h3 class="translate">Phonebook</h3></td>
    </tr>

    <tr>
        <th style="width:32px"></th>
        <th class="translate">Number</th>
        <th class="translate">Name</th>
        <th class="translate">Image</th>
        <th></th>
    </tr>
</table>
<input type="button" class="translateV" id="add_name" value="add name"/><br><br>

<p>
<h1 class="translate">Description</h1>
<span class="translate">Description text</span>
</p>
<script src="../lib/js/selectImage.js" type="text/javascript"></script>
<script src="../adapter/fritzBox/fritzBoxLang.js" type="text/javascript"></script>
<script type="text/javascript">
    var socket = io.connect( $(location).attr('protocol') + '//' +  $(location).attr('host') + "?key="+socketSession);
    imageSelect._rootDir = "www/ccu.io/img/";

    function storeSettings () {
        updateAdapterSettings();
    }

    if (currentAdapterSettings.enabled) {
        $("#fritzbox_enabled option[value='false']").removeAttr("selected");
        $("#fritzbox_enabled option[value='true']").attr("selected", true);
    } else {
        $("#fritzbox_enabled option[value='true']").removeAttr("selected");
        $("#fritzbox_enabled option[value='false']").attr("selected", true);
    }

    $("#fritzbox_enabled").change(function () {
        currentAdapterSettings.enabled = ($("#fritzbox_enabled option:selected").val() == "false" ? false : true);
        storeSettings();
    });

    $("#fritzbox_settings_ip").val(currentAdapterSettings.settings.IP || "192.168.1.1");

    $("#fritzbox_settings_ip").change(function () {
        currentAdapterSettings.settings.IP = $(this).val();
        storeSettings();
    });

    $("#fritzbox_settings_maxMissed").val(currentAdapterSettings.settings.maxMissed === undefined ? 10 : currentAdapterSettings.settings.maxMissed);

    $("#fritzbox_settings_maxMissed").change(function () {
        currentAdapterSettings.settings.maxMissed = $(this).val();
        if (currentAdapterSettings.settings.maxMissed > 100) {
            currentAdapterSettings.settings.maxMissed = 100;
            $(this).val(currentAdapterSettings.settings.maxMissed);
        }
        storeSettings();
    });

    $("#fritzbox_settings_maxAll").val(currentAdapterSettings.settings.maxAll === undefined ? 20 : currentAdapterSettings.settings.maxMissed);

    $("#fritzbox_settings_maxAll").change(function () {
        currentAdapterSettings.settings.maxAll = $(this).val();
        if (currentAdapterSettings.settings.maxAll > 100) {
            currentAdapterSettings.settings.maxAll = 100;
            $(this).val(currentAdapterSettings.settings.maxAll);
        }
        storeSettings();
    });

    function showEntry (id) {
        console.log(currentAdapterSettings.settings.phonebook[id]);

        var sText = '<tr class="fritzBox-optentry">';
        sText += '<td><img id="fritzBox_image_'    +id+'" data-fritzBox-entry="'+id+'" src="'+(currentAdapterSettings.settings.phonebook[id].img || "/ccu.io/img/call.png")+'" width="32" height="32"/></td>';
        sText += '<td><input id="fritzBox_number_' +id+'" data-fritzBox-entry="'+id+'" type="text" value="'+(currentAdapterSettings.settings.phonebook[id].number || "")+'"/></td>';
        sText += '<td><input id="fritzBox_name_'   +id+'" data-fritzBox-entry="'+id+'" type="text" value="'+(currentAdapterSettings.settings.phonebook[id].name   || "")+'"/></td>';
        sText += '<td><input id="fritzBox_img_'    +id+'" data-fritzBox-entry="'+id+'" type="text" value="'+(currentAdapterSettings.settings.phonebook[id].img    || "")+'"/><input type="button" id="fritzBox_img_btn_'+id+'" data-fritzBox-entry="'+id+'" value="..."></td>';
        sText += '<td><input data-fritzBox-entry="'+id+'" type="button" value="remove" class="fritzBox-remove"/></td>';
        sText += "</tr>";

        $("#fritzBox_table").append(sText);

        $(".fritzBox-remove:last").button().click(function () {
            fritzBoxRemoveEntry($(this).attr("data-fritzBox-entry"));
            storeSettings();
        }).keyup(function() { $(this).trigger("change")});

        $("#fritzBox_number_"+id).change(function () {
            currentAdapterSettings.settings.phonebook[$(this).attr('data-fritzBox-entry')].number = $(this).val();
            storeSettings();
        }).keyup(function() { $(this).trigger("change")});

        $("#fritzBox_name_"+id).change(function () {
            currentAdapterSettings.settings.phonebook[$(this).attr('data-fritzBox-entry')].name = $(this).val();
            storeSettings();
        }).keyup(function() { $(this).trigger("change")});

        $("#fritzBox_img_"+id).change(function () {
            currentAdapterSettings.settings.phonebook[$(this).attr('data-fritzBox-entry')].img = $(this).val();
            $('#fritzBox_image_' + $(this).attr('data-fritzBox-entry')).attr("src", $(this).val() || "/ccu.io/img/call.png");
            storeSettings();
        }).keyup(function() { $(this).trigger("change")});

        // Select image Dialog
        $("#fritzBox_img_btn_"+id).click ( function () {
            var img = $("#fritzBox_img_"+$(this).attr('data-fritzBox-entry')).val();
            img = img.replace ("/ccu.io/", "");
            var settings = {
                current: img,
                onselectArg: $(this).attr('data-fritzBox-entry'),
                onselect:    function (img, obj)
                {
                    $("#fritzBox_img_"+obj).val("/ccu.io/" + img);
                    $("#fritzBox_img_"+obj).trigger("change");
                }};
            imageSelect.Show (settings, socket);
        });
    }

    $("#add_name").button().click(function () {
        currentAdapterSettings.settings.phonebook[currentAdapterSettings.settings.phonebook.length] = {number: "", name:"", img: ""};
        showEntry (currentAdapterSettings.settings.phonebook.length - 1);
    });

    function fritzBoxRemoveEntry(j) {
        $("tr.fritzBox-optentry").remove();
        currentAdapterSettings.settings.phonebook.splice(j, 1);
        fritzBoxRefreshNames();
        storeSettings();
    }
    function fritzBoxRefreshNames () {
        for (var i = 0; i < currentAdapterSettings.settings.phonebook.length; i++) {
            showEntry (i);
        }
    }

    fritzBoxRefreshNames();
    translateAll (ccuIoLanguage, adapterWords);

</script>

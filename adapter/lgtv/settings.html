<table style="font-size: 12px" id="lgtv_table">
    <tr>
        <td>
            Enabled:
        </td>
        <td colspan='5'>
            <select id="lgtv_enabled">
                <option value="false">false</option>
                <option value="true">true</option>
            </select>
        </td>
    </tr>
    <tr>
        <th>IP Address</th>
        <th>Name</th>
        <th>Pair Key</th>
        <th>Rooms</th>
        <th>Functions</th>
        <th>Favorites</th>
        <th></th>
    </tr>
</table>
<input type="button" id="add_device" value="add device"/><br><br>
<input type="button" id="browse" value="Browse"/>
<p>
<h1>Hilfe</h1>
To control LG tv over ethernet write variable 73022 with text command or 73023 with command number.
<br>Following commands are supported:
<table>
    <tr><td colspan="2"><b>Menus</b>   </td></tr>
    <tr><td>menu_status_bar           </td><td>35       </td></tr>
    <tr><td>menu_quick_menu           </td><td>69       </td></tr>
    <tr><td>menu_home_menu            </td><td>67       </td></tr>
    <tr><td>menu_premium_menu         </td><td>89       </td></tr>
    <tr><td>menu_installation_menu    </td><td>207      </td></tr>
    <tr><td>menu_IN_START             </td><td>251      </td></tr>
    <tr><td>menu_EZ_ADJUST            </td><td>255      </td></tr>
    <tr><td>menu_power_only           </td><td>254      </td></tr>
    <tr><td colspan="2"><b> Power controls</b>   </td></tr>
    <tr><td>power_off                 </td><td>8        </td></tr>
    <tr><td>power_sleep_timer         </td><td>14       </td></tr>
    <tr><td colspan="2"><b> Navigation</b>   </td></tr>
    <tr><td>nav_left                  </td><td>7        </td></tr>
    <tr><td>nav_right                 </td><td>6        </td></tr>
    <tr><td>nav_up                    </td><td>64       </td></tr>
    <tr><td>nav_down                  </td><td>65       </td></tr>
    <tr><td>nav_select                </td><td>68       </td></tr>
    <tr><td>nav_back                  </td><td>40       </td></tr>
    <tr><td>nav_exit                  </td><td>91       </td></tr>
    <tr><td>nav_red                   </td><td>114      </td></tr>
    <tr><td>nav_green                 </td><td>113      </td></tr>
    <tr><td>nav_yellow                </td><td>99       </td></tr>
    <tr><td>nav_blue                  </td><td>97       </td></tr>
    <tr><td colspan="2"><b> keypad</b>   </td></tr>
    <tr><td>keypad_0                  </td><td>16       </td></tr>
    <tr><td>keypad_1                  </td><td>17       </td></tr>
    <tr><td>keypad_2                  </td><td>18       </td></tr>
    <tr><td>keypad_3                  </td><td>19       </td></tr>
    <tr><td>keypad_4                  </td><td>20       </td></tr>
    <tr><td>keypad_5                  </td><td>21       </td></tr>
    <tr><td>keypad_6                  </td><td>22       </td></tr>
    <tr><td>keypad_7                  </td><td>23       </td></tr>
    <tr><td>keypad_8                  </td><td>24       </td></tr>
    <tr><td>keypad_9                  </td><td>25       </td></tr>
    <tr><td>keypad__  (underline)     </td><td>76       </td></tr>
    <tr><td colspan="2"><b>Playback controls</b>   </td></tr>
    <tr><td>playback_play             </td><td>176      </td></tr>
    <tr><td>playback_pause            </td><td>186      </td></tr>
    <tr><td>playback_fast_forward     </td><td>142      </td></tr>
    <tr><td>playback_rewind           </td><td>143      </td></tr>
    <tr><td>playback_stop             </td><td>177      </td></tr>
    <tr><td>playback_record           </td><td>189      </td></tr>
    <tr><td colspan="2"><b> Input controls</b>   </td></tr>
    <tr><td>input_tv_radio            </td><td>15       </td></tr>
    <tr><td>input_simplink            </td><td>126      </td></tr>
    <tr><td>input_input               </td><td>11       </td></tr>
    <tr><td>input_component_rgb_hdmi  </td><td>152      </td></tr>
    <tr><td>input_component           </td><td>191      </td></tr>
    <tr><td>input_rgb                 </td><td>213      </td></tr>
    <tr><td>input_hdmi                </td><td>198      </td></tr>
    <tr><td>input_hdmi1               </td><td>206      </td></tr>
    <tr><td>input_hdmi2               </td><td>204      </td></tr>
    <tr><td>input_hdmi3               </td><td>233      </td></tr>
    <tr><td>input_hdmi4               </td><td>218      </td></tr>
    <tr><td>input_av1                 </td><td>90       </td></tr>
    <tr><td>input_av2                 </td><td>208      </td></tr>
    <tr><td>input_av3                 </td><td>209      </td></tr>
    <tr><td>input_usb                 </td><td>124      </td></tr>
    <tr><td>input_slideshow_usb1      </td><td>238      </td></tr>
    <tr><td>input_slideshow_usb2      </td><td>168      </td></tr>
    <tr><td colspan="2"><b> TV Controls</b>   </td></tr>
    <tr><td>tv_channel_up             </td><td>0        </td></tr>
    <tr><td>tv_channel_down           </td><td>1        </td></tr>
    <tr><td>tv_channel_back           </td><td>26       </td></tr>
    <tr><td>tv_favorites              </td><td>30       </td></tr>
    <tr><td>tv_teletext               </td><td>32       </td></tr>
    <tr><td>tv_t_opt                  </td><td>33       </td></tr>
    <tr><td>tv_channel_list           </td><td>83       </td></tr>
    <tr><td>tv_greyed_out_add_button  </td><td>85       </td></tr>
    <tr><td>tv_guide                  </td><td>169      </td></tr>
    <tr><td>tv_info                   </td><td>170      </td></tr>
    <tr><td>tv_live_tv                </td><td>158      </td></tr>
    <tr><td colspan="2"><b> Picture controls</b>   </td></tr>
    <tr><td>picture_av_mode           </td><td>48       </td></tr>
    <tr><td>picture_mode              </td><td>77       </td></tr>
    <tr><td>picture_ratio             </td><td>121      </td></tr>
    <tr><td>picture_ratio_4_3         </td><td>118      </td></tr>
    <tr><td>picture_ratio_16_9        </td><td>119      </td></tr>
    <tr><td>picture_energy_saving     </td><td>149      </td></tr>
    <tr><td>picture_cinema_zoom       </td><td>175      </td></tr>
    <tr><td>picture_3D                </td><td>220      </td></tr>
    <tr><td>picture_factory_check     </td><td>252      </td></tr>
    <tr><td colspan="2"><b> Audio controls</b>   </td></tr>
    <tr><td>audio_volume_up           </td><td>2        </td></tr>
    <tr><td>audio_volume_down         </td><td>3        </td></tr>
    <tr><td>audio_mute                </td><td>9        </td></tr>
    <tr><td>audio_language            </td><td>10       </td></tr>
    <tr><td>audio_sound_mode          </td><td>82       </td></tr>
    <tr><td>audio_factory_sound_check</td><td>253      </td></tr>
    <tr><td>audio_subtitle_language   </td><td>57       </td></tr>
    <tr><td>audio_audio_description   </td><td>145       </td></tr>
</table>
</p>
<p>Some LG devices have a bug, that network stack is not active at start. To activate network stack on LG device set up network settings one more time.</p>
<script type="text/javascript">

    var socket = io.connect( $(location).attr('protocol') + '//' +  $(location).attr('host') + "?key="+socketSession);

    function storeSettings () {
        console.log (JSON.stringify(currentAdapterSettings));
        updateAdapterSettings();
    }

	function showDevice (id) {
		var sText = '<tr class="lgtv-optdevice">';
		sText += '<td><input id="lgtv_ip_'  +id+'" data-lgtv-device="'+id+'" type="text" value="'+(currentAdapterSettings.settings.devices[id].ip   || "")+'"/></td>';
		sText += '<td><input id="lgtv_name_'+id+'" data-lgtv-device="'+id+'" type="text" value="'+(currentAdapterSettings.settings.devices[id].name || "")+'"/></td>';
        sText += '<td><input id="lgtv_pair_'+id+'" data-lgtv-device="'+id+'" type="text" value="'+(currentAdapterSettings.settings.devices[id].pairKey || "")+'"/></td>';

		var t = "";
        if (currentAdapterSettings.settings.devices[id].rooms) {
            for (var i = 0; i < currentAdapterSettings.settings.devices[id].rooms.length; i++) {
                t += ((t == "") ? "":",") + currentAdapterSettings.settings.devices[id].rooms[i];
            }
        }
		sText += '<td><input id="lgtv_rooms_'+id+'" data-lgtv-device="'+id+'" type="text" value="'+t+'"/></td>';
		
		
		t = "";
        if (currentAdapterSettings.settings.devices[id].funcs) {
            for (var i = 0; i < currentAdapterSettings.settings.devices[id].funcs.length; i++) {
                t += ((t == "") ? "":",") + currentAdapterSettings.settings.devices[id].funcs[i];
            }
        }
		sText += '<td><input id="lgtv_funcs_'+id+'" data-lgtv-device="'+id+'" type="text" value="'+t+'"/></td>';
		
		t = "";
        if (currentAdapterSettings.settings.devices[id].favs) {
            for (var i = 0; i < currentAdapterSettings.settings.devices[id].favs.length; i++) {
                t += ((t == "") ? "":",") + currentAdapterSettings.settings.devices[id].favs[i];
            }
        }
		sText += '<td><input id="lgtv_favs_'+id+'" data-lgtv-device="'+id+'" type="text" value="'+t+'"/></td>';

        sText += '<td><input data-lgtv-device="'+id+'" type="button" value="show pair" class="lgtv-show-pair"/></td>';
        sText += '<td><input data-lgtv-device="'+id+'" type="button" value="remove device" class="lgtv-remove"/></td>';
		sText += "</tr>";

		$("#lgtv_table").append(sText);

        $(".lgtv-remove:last").button().click(function () {
            lgtvRemoveDevice($(this).attr("data-lgtv-device"));
            storeSettings();
        }).keyup(function() { $(this).trigger("change")});

        $(".lgtv-show-pair:last").button().click(function () {
            if (currentAdapterSettings.settings.devices[$(this).attr('data-lgtv-device')]) {
                lgtvShowPair (currentAdapterSettings.settings.devices[$(this).attr('data-lgtv-device')]["ip"]);
            }
        }).keyup(function() { $(this).trigger("change")});

        $("#lgtv_name_"+id).change(function () {
            currentAdapterSettings.settings.devices[$(this).attr('data-lgtv-device')].name = $(this).val();
            storeSettings();
        }).keyup(function() { $(this).trigger("change")});

		$("#lgtv_pair_"+id).change(function () {
            currentAdapterSettings.settings.devices[$(this).attr('data-lgtv-device')].pairKey = $(this).val().toUpperCase();
			if (currentAdapterSettings.settings.devices[$(this).attr('data-lgtv-device')].pairKey != $(this).val()) {
				$(this).val(currentAdapterSettings.settings.devices[$(this).attr('data-lgtv-device')].pairKey);
			}
            storeSettings();
        }).keyup(function() { $(this).trigger("change")});
		
        $("#lgtv_ip_"+id).change(function () {
            if ($(this).val().match(/\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b/)) {
				currentAdapterSettings.settings.devices[$(this).attr('data-lgtv-device')].ip = $(this).val();
				storeSettings();
				$(this).css({color: "black"});
			}
			else {
				$(this).css({color: "red"});
			}
        }).keyup(function() { $(this).trigger("change")});

        $("#lgtv_rooms_"+id).change(function () {
            var arr = $(this).val().split(',');

            for (var t = 0; t < arr.length; t++)
                arr[t] = arr[t].trim();

            currentAdapterSettings.settings.devices[$(this).attr('data-lgtv-device')].rooms = arr;

            storeSettings();
        }).keyup(function() { $(this).trigger("change")});

        $("#lgtv_funcs_"+id).change(function () {
            var arr = $(this).val().split(',');

            for (var t = 0; t < arr.length; t++)
                arr[t] = arr[t].trim();

            currentAdapterSettings.settings.devices[$(this).attr('data-lgtv-device')].funcs = arr;

            storeSettings();
        }).keyup(function() { $(this).trigger("change")});
    }
	
    function lgtvRefreshDevices() {
        for (var id in currentAdapterSettings.settings.devices) {
			showDevice (id);
        }
        $(".lgtv-remove").button().click(function () {
            var j = $(this).attr("data-lgtv-device");
            lgtvRemoveDevice(j);
        });
    }
    lgtvRefreshDevices();

    if (currentAdapterSettings.enabled) {
        $("#lgtv_enabled option[value='false']").removeAttr("selected");
        $("#lgtv_enabled option[value='true']").attr("selected", true);
    } else {
        $("#lgtv_enabled option[value='true']").removeAttr("selected");
        $("#lgtv_enabled option[value='false']").attr("selected", true);
    }

    $("#lgtv_enabled").change(function () {
        currentAdapterSettings.enabled = ($("#lgtv_enabled option:selected").val() == "false" ? false : true);
        storeSettings();
    }).keyup(function() { $(this).trigger("change")});

    $("#add_device").button().click(function () {
        // Find free id
        var i = 1;
        while (currentAdapterSettings.settings.devices["_"+i]) i++;

        currentAdapterSettings.settings.devices["_"+i] = {ip: "0.0.0.1", name:"", rooms:[""], funcs:[""], pairKey: ""};
        showDevice ("_"+i);
    });

    $("#browse").button().click(function () {
        lgtvBrowse ();
    });

    function lgtvRemoveDevice(j) {
        $("tr.lgtv-optdevice").remove();
        delete currentAdapterSettings.settings.devices[j];
        lgtvRefreshDevices();
        storeSettings();
    }

    function lgtvBrowse () {
        socket.emit('execScript', "adapter/lgtv/lgtvBrowse.js", [""], function(script, arg, result) {
            var IPs = result.split(",");
            console.log (result);
            for (var u = 0; u < IPs.length; u++) {
                var isFound = false;
                for (var id in currentAdapterSettings.settings.devices) {
                    if (currentAdapterSettings.settings.devices[id].ip == IPs[u]) {
                        isFound = true;
                        break;
                    }
                }
                if (!isFound) {
                    // Find free id
                    var i = 1;
                    while (currentAdapterSettings.settings.devices["_"+i]) i++;

                    currentAdapterSettings.settings.devices["_"+i] = {ip: IPs[u], name:"", rooms:[""], funcs:["Media"], pairKey: ""};
                    showDevice ("_"+i);
                }
            }
        });
    }

    function lgtvShowPair(ip) {
        console.log ("SHOW:"+ip);
        socket.emit('execScript', "adapter/lgtv/lgtvPair.js", [ip]);
    }

</script>
